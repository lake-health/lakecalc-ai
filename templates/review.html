<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lakecalc-AI Review</title>
  <link rel="stylesheet" href="/static/review.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <main>
    <h1>Review Parsed Fields</h1>
    <form id="revform">
      <label>File ID <input name="file_id" value="{{file_id}}" readonly /></label>
      <div class="grid">
        <div>
          <h2>OD</h2>
          <label>axial_length <input name="od.axial_length" /></label>
          <label>acd <input name="od.acd" /></label>
          <label>lt <input name="od.lt" /></label>
          <label>cct <input name="od.cct" /></label>
          <label>wtw <input name="od.wtw" /></label>
          <label>k1 <input name="od.k1" /></label>
          <label>k1 axis <input name="od.k1_axis" /></label>
          <label>k2 <input name="od.k2" /></label>
          <label>k2 axis <input name="od.k2_axis" /></label>
          <label>ak <input name="od.ak" /></label>
          
        </div>
        <div>
          <h2>OS</h2>
          <label>axial_length <input name="os.axial_length" /></label>
          <label>acd <input name="os.acd" /></label>
          <label>lt <input name="os.lt" /></label>
          <label>cct <input name="os.cct" /></label>
          <label>wtw <input name="os.wtw" /></label>
          <label>k1 <input name="os.k1" /></label>
          <label>k1 axis <input name="os.k1_axis" /></label>
          <label>k2 <input name="os.k2" /></label>
          <label>k2 axis <input name="os.k2_axis" /></label>
          <label>ak <input name="os.ak" /></label>
          
        </div>
      </div>
      <button type="submit">Save Review</button>
    </form>

    <section>
      <h2>Toric Suggestion</h2>
      <form id="toric">
        <label>deltaK <input step="0.01" name="deltaK" required /></label>
        <label>SIA (abs) <input step="0.01" name="sia" /></label>
        <button type="submit">Suggest</button>
      </form>
      <pre id="toric_out"></pre>
    </section>
  </main>

  <script>
  async function postJSON(url, data){
    const r = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
    return await r.json();
  }
  async function fetchJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error('Fetch failed: '+r.status);
    return await r.json();
  }
  document.getElementById('revform').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const file_id = fd.get('file_id');
    const edits = {};
    for (const [k,v] of fd.entries()){
      if(k==='file_id') continue; edits[k]=v;
    }
    const out = await postJSON('/review', {file_id, edits});
    alert('Saved. Flags: '+ (out.flags||[]).join('; '));
  });
  document.getElementById('toric').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const q = { deltaK: parseFloat(fd.get('deltaK')), sia: fd.get('sia')? parseFloat(fd.get('sia')): null };
    const out = await postJSON('/suggest', q);
    document.getElementById('toric_out').textContent = JSON.stringify(out, null, 2);
  });

  // Auto-fill form values from /extract/{file_id}
  (async function autofill(){
    try{
      const file_id = document.querySelector('input[name=file_id]').value;
      if(!file_id) return;
      const url = `/extract/${encodeURIComponent(file_id)}`;
      const data = await fetchJSON(url);
      // fill nested fields
      function setIfExists(name, value){
        const el = document.querySelector(`input[name="${name}"]`);
        if(el && (value !== undefined && value !== null)) el.value = value;
      }
      for(const eye of ['od','os']){
        const obj = data[eye] || {};
        setIfExists(`${eye}.axial_length`, obj.axial_length);
        setIfExists(`${eye}.acd`, obj.acd);
        setIfExists(`${eye}.lt`, obj.lt);
        setIfExists(`${eye}.cct`, obj.cct);
        setIfExists(`${eye}.wtw`, obj.wtw);
        setIfExists(`${eye}.k1`, obj.k1?.value ?? obj.k1 ?? '');
        setIfExists(`${eye}.k1_axis`, obj.k1?.axis ?? obj.k1_axis ?? '');
        setIfExists(`${eye}.k2`, obj.k2?.value ?? obj.k2 ?? '');
        setIfExists(`${eye}.k2_axis`, obj.k2?.axis ?? obj.k2_axis ?? '');
  setIfExists(`${eye}.ak`, obj.ak);
      }
    }catch(e){
      console.warn('Autofill failed', e);
    }
  })();
  </script>
</body>
</html>
